name: Update Products from Google Sheets

on:
  schedule:
    - cron: '*/30 * * * *'  # Every 30 minutes
  workflow_dispatch:
  push:
    paths:
      - 'generate-products.js'
      - '.github/workflows/update-products.yml'

jobs:
  update-products:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    # Step 1: Get the code
    - name: Checkout repository
      uses: actions/checkout@v4
    
    # Step 2: Setup Node.js (FIXED - removed cache)
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        # REMOVED cache line since no dependencies
    
    # Step 3: Create package.json if missing
    - name: Create package.json
      run: |
        if [ ! -f package.json ]; then
          echo '{
            "name": "mati-suppliers",
            "version": "1.0.0",
            "description": "MATI SUPPLIERS website",
            "main": "generate-products.js",
            "scripts": {
              "generate": "node generate-products.js"
            },
            "keywords": ["suppliers", "procurement"],
            "author": "MATI SUPPLIERS",
            "license": "MIT"
          }' > package.json
          echo "‚úÖ Created package.json"
        else
          echo "üì¶ package.json already exists"
        fi
    
    # Step 4: Generate products from Google Sheets
    - name: Generate products
      run: |
        echo "========================================"
        echo "üîÑ UPDATING PRODUCTS FROM GOOGLE SHEETS"
        echo "========================================"
        echo "‚è∞ Started at: $(date)"
        echo ""
        
        # Run the Google Sheets script
        node generate-products.js
        
        # Show results
        echo ""
        echo "üìã UPDATE RESULTS:"
        if [ -f products.json ]; then
          PRODUCT_COUNT=$(node -e "try { const data = require('./products.json'); console.log(data.products?.length || 0) } catch(e) { console.log(0) }")
          echo "‚úÖ Products loaded: $PRODUCT_COUNT"
        fi
    
    # Step 5: Commit and push changes
    - name: Commit changes
      run: |
        # Configure git
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "GitHub Actions Bot"
        
        # Add product files
        git add products.json products.js
        
        # Check if there are changes
        if git diff --quiet && git diff --staged --quiet; then
          echo "‚úÖ No changes - Google Sheets data unchanged"
        else
          # Create commit message
          TIMESTAMP=$(date +'%Y-%m-%d %H:%M:%S')
          git commit -m "üîÑ Auto-update products [$TIMESTAMP]"
          git push
          echo "‚úÖ Successfully updated and pushed changes"
        fi
    
    # Step 6: Final status
    - name: Update Status
      run: |
        echo ""
        echo "========================================"
        echo "üéâ PRODUCTS UPDATE COMPLETE"
        echo "========================================"
        echo "‚è∞ Next auto-update: 30 minutes"
        echo "üìÖ Manual trigger: Go to Actions ‚Üí Run workflow"
        echo "========================================"
