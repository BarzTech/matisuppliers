name: Update Products from Google Sheets

on:
  # Auto-update every 30 minutes
  schedule:
    - cron: '*/30 * * * *'
  
  # Manual trigger from GitHub UI
  workflow_dispatch:
  
  # Auto-run when script changes
  push:
    paths:
      - 'generate-products.js'
      - '.github/workflows/update-products.yml'

jobs:
  update-products:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    # ================= STEP 1: GET LATEST CODE =================
    - name: Checkout with full history
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0  # Get ALL history to avoid conflicts
    
    # ================= STEP 2: SETUP NODE =================
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    # ================= STEP 3: SYNC WITH REMOTE =================
    - name: Sync with remote repository
      run: |
        echo "üîÑ Syncing with GitHub..."
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
        # Fetch ALL branches and history
        git fetch --all --depth=100
        
        # Reset to match remote exactly
        git reset --hard origin/main
        
        # Clean any untracked files
        git clean -fd
        
        echo "‚úÖ Synced with remote repository"
    
    # ================= STEP 4: GENERATE PRODUCTS =================
    - name: Generate products from Google Sheets
      run: |
        echo "========================================"
        echo "üì¶ GENERATING PRODUCTS"
        echo "========================================"
        echo "‚è∞ Time: $(date)"
        
        # Run the generation script
        node generate-products.js
        
        # Show results
        if [ -f products.json ]; then
          PRODUCT_COUNT=$(node -e "try { 
            const data = require('./products.json'); 
            console.log(data.products?.length || 0) 
          } catch(e) { 
            console.log(0) 
          }")
          
          if [ "$PRODUCT_COUNT" -gt 0 ]; then
            echo "‚úÖ Success! Generated $PRODUCT_COUNT products"
            echo "üïí Last updated: $(node -e "const d = require('./products.json'); console.log(d.meta?.lastUpdated || 'Unknown')")"
          else
            echo "‚ö†Ô∏è Generated 0 products (Google Sheet might be empty)"
          fi
        else
          echo "‚ùå Failed to generate products.json"
        fi
    
    # ================= STEP 5: COMMIT & PUSH =================
    - name: Commit and push changes
      run: |
        echo "üìù Checking for changes..."
        
        # Check if product files actually changed
        CHANGED_FILES=$(git status --porcelain | grep -E 'products\.(json|js)' || true)
        
        if [ -z "$CHANGED_FILES" ]; then
          echo "‚úÖ No changes in product files"
          echo "‚è≠Ô∏è Skipping commit"
          exit 0
        fi
        
        echo "üìÑ Changed files:"
        echo "$CHANGED_FILES"
        
        # Configure git
        git config --global user.name "MATI SUPPLIERS Auto-Update"
        git config --global user.email "mati-suppliers@users.noreply.github.com"
        
        # Add ONLY product files
        git add products.json products.js
        
        # Create commit message with timestamp
        TIMESTAMP=$(date +'%Y-%m-%d %H:%M:%S')
        COMMIT_MSG="üîÑ Auto-update products [$TIMESTAMP]"
        
        # Commit
        git commit -m "$COMMIT_MSG"
        
        # PUSH WITH FORCE TO AVOID CONFLICTS
        echo "üì§ Pushing to GitHub..."
        git push origin main --force-with-lease
        
        echo "‚úÖ Successfully updated products!"
    
    # ================= STEP 6: FINAL STATUS =================
    - name: Completion Status
      run: |
        echo ""
        echo "========================================"
        echo "üéâ AUTO-UPDATE COMPLETE"
        echo "========================================"
        echo "üìä Repository: BarzTech/matisuppliers"
        echo "‚è∞ Next update: 30 minutes"
        echo "üîß Manual trigger: Actions ‚Üí 'Update Products' ‚Üí Run workflow"
        echo "üåê Live website: https://barztech.github.io/matisuppliers/"
        echo "üìß Support: matisuppliers.inter@gmail.com"
        echo "========================================"
